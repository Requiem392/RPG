-- States/Alert.module.luau
local Alert = {}

local ServerScriptService = game:GetService("ServerScriptService")
local NPCPerception = require(ServerScriptService.NPCPerception)
local NPCMovement = require(ServerScriptService.NPCMovement) 

-- ConfiguraÃ§Ã£o do Comportamento
local LOOK_DURATION = 1.5
local SEARCH_RADIUS = 8
local MOVE_SPEED = 8
local SEARCH_SPEED = 6
local OBSERVE_DURATION = 2.5
local MAX_SEARCH_STEPS = 6

function Alert.Enter(npc, context)
	-- Inicializa Fases
	context.AlertPhase = "LOOK"
	context.AlertStartTime = tick()
	context.CurrentPhaseStartTime = tick()
	
	-- Inicializa SEARCH (mesmo que nÃ£o use agora)
	context.SearchStep = 1
	context.IsObserving = false
	context.AlertTargetPos = nil -- Fixa a posiÃ§Ã£o do som
	
	NPCMovement.Stop(npc) 
	print(npc.Name .. " ðŸ‘€ ouviu algo... (LOOK)")
end

function Alert.Update(npc, context, dt)
	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	if not npcRoot then return end

	local currentTime = tick()
	local phaseTime = currentTime - context.CurrentPhaseStartTime
	
	-- Busca dados UMA VEZ para fixar alvo se necessÃ¡rio
	if not context.AlertTargetPos then
		local data = NPCPerception.GetData(npc)
		if data and data.SuspectPosition then 
			context.AlertTargetPos = data.SuspectPosition
		else
			return -- Sem alvo, NPCDecision resolve
		end
	end

	-- MÃQUINA DE ESTADOS INTERNA
	
	-- ======================================================================
	-- FASE 1: LOOK (Parado -> Move)
	-- ======================================================================
	if context.AlertPhase == "LOOK" then
		-- Apenas espera (NÃƒO GIRA MAIS MANUALMENTE)
		-- Futuro: Tocar animaÃ§Ã£o de "olhar para os lados"
		
		-- TransiÃ§Ã£o -> MOVE
		if phaseTime >= LOOK_DURATION then
			context.AlertPhase = "MOVE"
			context.CurrentPhaseStartTime = currentTime
			context.InvestigationLocked = true -- TRAVA! Agora ele vai atÃ© o fim
			print(npc.Name .. " ðŸ‘£ investigando... (MOVE)")
		end
		
	-- ======================================================================
	-- FASE 2: MOVE (Vai atÃ© o som)
	-- ======================================================================
	elseif context.AlertPhase == "MOVE" then
		NPCMovement.MoveTo(npc, context.AlertTargetPos, {speed = MOVE_SPEED})
		
		local dist = (npcRoot.Position - context.AlertTargetPos).Magnitude
		
		-- TransiÃ§Ã£o -> SEARCH (SÃ“ QUANDO CHEGAR)
		if dist < 1.5 then 
			context.AlertPhase = "SEARCH"
			context.CurrentPhaseStartTime = currentTime
			context.SearchStep = 1
			context.NextSearchPoint = nil 
			-- Reset context values
			context.PointArriveTime = nil
			context.IsObserving = false
			print(npc.Name .. " ðŸ” chegou no local suspeito... SEARCH inicado.")
		end
		
	-- ======================================================================
	-- FASE 3: SEARCH (6 Passos)
	-- ======================================================================
	elseif context.AlertPhase == "SEARCH" then
		
		-- Se terminou os passos, libera a trava e para
		if context.SearchStep > MAX_SEARCH_STEPS then
			context.InvestigationLocked = false -- DESTRAVA! Pode voltar pra Idle
			NPCMovement.Stop(npc)
			return
		end

		-- PENÃšLTIMO PASSO: OBSERVAÃ‡ÃƒO (ObrigatÃ³rio)
		if context.SearchStep == MAX_SEARCH_STEPS - 1 then
			if not context.IsObserving then
				context.IsObserving = true
				context.ObserveStartTime = currentTime
				NPCMovement.Stop(npc)
				print(npc.Name .. " ðŸ‘€ observando Ã¡rea... (Step " .. context.SearchStep .. ")")
			end
			
			-- RotaÃ§Ã£o 360 Suave (via NPCMovement)
			local elapsedTime = currentTime - context.ObserveStartTime
			local angle = elapsedTime * 2 -- Velocidade de rotaÃ§Ã£o
			local rotDir = Vector3.new(math.sin(angle), 0, math.cos(angle))
			NPCMovement.FaceDirection(npc, rotDir)
			
			-- Acabou observaÃ§Ã£o? PrÃ³ximo passo
			if elapsedTime >= OBSERVE_DURATION then
				context.IsObserving = false
				context.SearchStep = context.SearchStep + 1
				context.NextSearchPoint = nil
				print(npc.Name .. " ðŸ” busca retomada...")
			end
			return
		end
		
		-- PASSOS DE MOVIMENTO
		if not context.NextSearchPoint then
			local randomOffset = Vector3.new(
				math.random(-SEARCH_RADIUS, SEARCH_RADIUS),
				0,
				math.random(-SEARCH_RADIUS, SEARCH_RADIUS)
			)
			context.NextSearchPoint = context.AlertTargetPos + randomOffset
			context.PointArriveTime = nil -- Reset timer
		end
		
		-- Se jÃ¡ chegou, espera. Se nÃ£o, anda.
		if context.PointArriveTime then
			NPCMovement.Stop(npc)
			if currentTime - context.PointArriveTime > 1.5 then -- Pausa de 1.5s
				context.SearchStep = context.SearchStep + 1
				context.NextSearchPoint = nil
				context.PointArriveTime = nil
				if context.SearchStep <= MAX_SEARCH_STEPS then
					print(npc.Name .. " ðŸ” indo para Step " .. context.SearchStep)
				end
			end
		else
			-- Anda atÃ© o ponto
			NPCMovement.MoveTo(npc, context.NextSearchPoint, {speed = SEARCH_SPEED})
			
			-- Verifica chegada (ESTRITA)
			if context.NextSearchPoint then
				local distToPoint = (Vector3.new(npcRoot.Position.X, 0, npcRoot.Position.Z) - Vector3.new(context.NextSearchPoint.X, 0, context.NextSearchPoint.Z)).Magnitude
				
				if distToPoint < 1.5 then -- Chegou no ponto EXATO!
					context.PointArriveTime = currentTime 
					NPCMovement.Stop(npc)
					print(npc.Name .. " ðŸ›‘ chegou no ponto... verificando.")
				end
			end
		end
	end
end

function Alert.Exit(npc, context)
	NPCMovement.Stop(npc)
	
	-- Limpa contexto
	context.AlertPhase = nil
	context.AlertStartTime = nil
	context.AlertTargetPos = nil
	context.SearchStep = nil
	context.IsObserving = nil
	context.NextSearchPoint = nil
end

return Alert
