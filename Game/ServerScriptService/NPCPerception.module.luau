--[[
	NPCPerception.module.luau
	
	Pilar 1: PERCEP√á√ÉO
	
	Responsabilidades:
	- Vis√£o (Range + FOV + Raycast)
	- Audi√ß√£o (Detec√ß√£o de som)
	- Mem√≥ria (Reten√ß√£o temporal)
	- Valida√ß√£o de alvos
	
	N√ÉO FAZ:
	- Tomar decis√µes
	- Atacar
	- Mover
	- Mudar estado
]]

local Players = game:GetService("Players")
local RunService = game:GetService("RunService")

local NPCPerception = {}

-- ======================================================================
-- CONFIGURA√á√ÉO
-- ======================================================================

local DEBUG_VISION = true  -- Ativa/desativa visualiza√ß√£o do raycast

local VisionConfig = {
	Range = 50,              -- Alcance m√°ximo de vis√£o (studs)
	FieldOfView = 120,       -- √Çngulo de vis√£o (graus)
	UpdateInterval = 0.2     -- Atualiza a cada 0.2s
}

local HearingConfig = {
	Range = 30,              -- Alcance de audi√ß√£o (studs)
	NoiseThreshold = 16      -- WalkSpeed m√≠nima para emitir som
}

local MemoryConfig = {
	RetentionTime = 5,       -- Tempo que lembra do alvo (segundos)
	SuspectDuration = 12     -- Tempo que mant√©m suspeita auditiva (segundos)
}

-- ======================================================================
-- DADOS DE PERCEP√á√ÉO (por NPC)
-- ======================================================================

local PerceptionData = {}

function NPCPerception.InitializeNPC(npc)
	if not npc or not npc:IsA("Model") then
		warn("[Perception] NPC inv√°lido:", npc)
		return
	end
	
	PerceptionData[npc] = {
		-- Vis√£o (confirma√ß√£o real)
		HasVisual = false,
		LastSeenPosition = nil,
		LastSeenTime = 0,
		DistanceToTarget = math.huge,
		
		-- Audi√ß√£o (suspeita)
		HasSuspicion = false,
		SuspectPosition = nil,
		SuspectTime = 0,
		
		-- Alvo Atual
		CurrentTarget = nil
	}
	
	print("‚úÖ [Perception] Inicializado para:", npc.Name)
end

-- ======================================================================
-- VALIDA√á√ÉO DE ALVO
-- ======================================================================

local function IsValidTarget(player)
	-- Player existe e tem Character?
	if not player or not player.Character then return false end
	
	-- Humanoid vivo?
	local humanoid = player.Character:FindFirstChild("Humanoid")
	if not humanoid or humanoid.Health <= 0 then return false end
	
	-- TODO: Adicionar checagens de equipe/invisibilidade se necess√°rio
	
	return true
end

-- ======================================================================
-- VIS√ÉO (Vision)
-- ======================================================================

local function CheckVision(npc, target)
	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	local targetRoot = target.Character:FindFirstChild("HumanoidRootPart")
	
	if not npcRoot or not targetRoot then
		return false, math.huge
	end
	
	-- 1. Verifica√ß√£o de Alcance
	local distance = (npcRoot.Position - targetRoot.Position).Magnitude
	if distance > VisionConfig.Range then
		return false, distance
	end
	
	-- 2. Campo de Vis√£o (FOV)
	local lookVector = npcRoot.CFrame.LookVector
	local directionToTarget = (targetRoot.Position - npcRoot.Position).Unit
	local dotProduct = lookVector:Dot(directionToTarget)
	local angle = math.deg(math.acos(dotProduct))
	
	if angle > (VisionConfig.FieldOfView / 2) then
		return false, distance
	end
	
	-- 3. Raycast de Obstru√ß√£o
	local raycastParams = RaycastParams.new()
	raycastParams.FilterDescendantsInstances = {npc, target.Character}
	raycastParams.FilterType = Enum.RaycastFilterType.Exclude
	
	local rayDirection = targetRoot.Position - npcRoot.Position
	local rayResult = workspace:Raycast(
		npcRoot.Position,
		rayDirection,
		raycastParams
	)
	
	-- DEBUG: Visualiza raycast
	if DEBUG_VISION then
		local rayColor = rayResult and Color3.fromRGB(255, 0, 0) or Color3.fromRGB(0, 255, 0)
		local rayPart = Instance.new("Part")
		rayPart.Anchored = true
		rayPart.CanCollide = false
		rayPart.Size = Vector3.new(0.1, 0.1, rayDirection.Magnitude)
		rayPart.CFrame = CFrame.new(npcRoot.Position, targetRoot.Position) * CFrame.new(0, 0, -rayDirection.Magnitude / 2)
		rayPart.Color = rayColor
		rayPart.Material = Enum.Material.Neon
		rayPart.Parent = workspace
		game:GetService("Debris"):AddItem(rayPart, 0.2)
	end
	
	-- Se raycast acertou algo, vis√£o bloqueada
	if rayResult then
		return false, distance
	end
	
	-- Passou em todas as checagens
	return true, distance
end

-- ======================================================================
-- AUDI√á√ÉO (Hearing)
-- ======================================================================

local function CheckHearing(npc, target)
	local npcRoot = npc:FindFirstChild("HumanoidRootPart")
	local targetRoot = target.Character:FindFirstChild("HumanoidRootPart")
	local targetHumanoid = target.Character:FindFirstChild("Humanoid")
	
	if not npcRoot or not targetRoot or not targetHumanoid then
		return false, nil
	end
	
	-- 1. Dist√¢ncia (LIMITE R√çGIDO: 30 studs)
	local distance = (npcRoot.Position - targetRoot.Position).Magnitude
	if distance > HearingConfig.Range then
		return false, nil
	end
	
	-- 2. Player est√° se movendo r√°pido o suficiente?
	-- Precisamos checar a velocidade REAL (Velocity), n√£o o WalkSpeed (Capacidade)
	local velocity = targetRoot.AssemblyLinearVelocity * Vector3.new(1, 0, 1) -- Ignora eixo Y (pulo/queda)
	if velocity.Magnitude < HearingConfig.NoiseThreshold then
		return false, nil
	end
	
	-- 3. Posi√ß√£o aproximada (¬±5 studs de offset aleat√≥rio)
	local offset = Vector3.new(
		math.random(-5, 5),
		0,
		math.random(-5, 5)
	)
	local approximatePosition = targetRoot.Position + offset
	
	return true, approximatePosition
end

-- ======================================================================
-- MEM√ìRIA (Memory) - S√≥ para Vis√£o
-- ======================================================================

local function UpdateMemory(data, currentTime)
	-- Mem√≥ria visual
	if data.LastSeenTime > 0 then
		local memoryAge = currentTime - data.LastSeenTime
		
		-- Ainda dentro do tempo de reten√ß√£o?
		if memoryAge <= MemoryConfig.RetentionTime then
			-- Mant√©m LastSeenPosition v√°lida
		else
			-- Esqueceu
			data.LastSeenPosition = nil
		end
	end
	
	-- Suspeita auditiva
	if data.SuspectTime > 0 then
		local suspectAge = currentTime - data.SuspectTime
		
		-- Ainda dentro do tempo de suspeita?
		if suspectAge <= MemoryConfig.SuspectDuration then
			data.HasSuspicion = true
		else
			-- Suspeita expirou
			data.HasSuspicion = false
			data.SuspectPosition = nil
		end
	else
		data.HasSuspicion = false
	end
end

-- ======================================================================
-- ATUALIZA√á√ÉO PRINCIPAL
-- ======================================================================

function NPCPerception.Update(npc)
	local data = PerceptionData[npc]
	if not data then
		warn("[Perception] NPC n√£o inicializado:", npc.Name)
		return
	end
	
	local currentTime = tick()
	
	-- Encontra alvo mais pr√≥ximo (por enquanto, primeiro player vivo)
	local closestPlayer = nil
	local closestDistance = math.huge
	
	for _, player in ipairs(Players:GetPlayers()) do
		if IsValidTarget(player) then
			local npcRoot = npc:FindFirstChild("HumanoidRootPart")
			local targetRoot = player.Character:FindFirstChild("HumanoidRootPart")
			
			if npcRoot and targetRoot then
				local dist = (npcRoot.Position - targetRoot.Position).Magnitude
				if dist < closestDistance then
					closestDistance = dist
					closestPlayer = player
				end
			end
		end
	end
	
	-- Se n√£o tem alvo v√°lido, limpa dados
	if not closestPlayer then
		data.CurrentTarget = nil
		data.HasVisual = false
		data.HasSuspicion = false
		UpdateMemory(data, currentTime)
		return
	end
	
	-- Atualiza alvo atual
	data.CurrentTarget = closestPlayer
	
	-- Atualiza Vis√£o (confirma√ß√£o real)
	local canSee, distance = CheckVision(npc, closestPlayer)
	data.HasVisual = canSee
	data.DistanceToTarget = distance
	
	if canSee then
		-- Vis√£o atualiza LastSeen*
		data.LastSeenPosition = closestPlayer.Character.HumanoidRootPart.Position
		data.LastSeenTime = currentTime
	end
	
	-- Atualiza Audi√ß√£o (suspeita)
	local heardNoise, suspectPos = CheckHearing(npc, closestPlayer)
	
	if heardNoise then
		-- Audi√ß√£o atualiza Suspect*
		data.SuspectPosition = suspectPos
		data.SuspectTime = currentTime
		data.HasSuspicion = true
	end
	
	-- Atualiza Mem√≥ria (visual e suspeita)
	UpdateMemory(data, currentTime)
end

-- ======================================================================
-- API P√öBLICA
-- ======================================================================

function NPCPerception.GetData(npc)
	return PerceptionData[npc]
end

function NPCPerception.Cleanup(npc)
	PerceptionData[npc] = nil
	print("üóëÔ∏è [Perception] Removido:", npc.Name)
end

return NPCPerception
