--[[
	NPCStateMachine.module.luau
	
	Pilar 2: STATE MACHINE
	
	Responsabilidades:
	- Gerenciar estado atual (Enter, Update, Exit)
	- Processar transi√ß√µes de estado
	- Garantir que apenas UM estado esteja ativo
	
	N√ÉO FAZ:
	- Tomar decis√µes (Pilar 3)
	- Executar combate (Pilar 5)
]]

local NPCStateMachine = {}
local States = {}

-- Carrega todos os estados da pasta States
local StatesFolder = script.Parent:WaitForChild("States")
for _, module in ipairs(StatesFolder:GetChildren()) do
	if module:IsA("ModuleScript") then
		States[module.Name] = require(module)
		print("üì¶ [StateMachine] Estado carregado:", module.Name)
	end
end

-- ======================================================================
-- DADOS DE ESTADO (por NPC)
-- ======================================================================

local StateData = {}

function NPCStateMachine.InitializeNPC(npc)
	StateData[npc] = {
		CurrentState = nil,
		StateName = "None",
		StateTime = 0,
		Context = {}  -- Dados compartilhados entre estados
	}
	
	-- Estado inicial padr√£o: IDLE
	NPCStateMachine.ChangeState(npc, "Idle")
end

-- ======================================================================
-- TRANSI√á√ÉO DE ESTADO
-- ======================================================================

function NPCStateMachine.ChangeState(npc, newStateName)
	local data = StateData[npc]
	if not data then return end
	
	-- Se j√° est√° no estado e ele n√£o permite reentrada, ignora
	if data.StateName == newStateName then
		return
	end
	
	local newState = States[newStateName]
	if not newState then
		warn("‚ùå [StateMachine] Estado inexistente:", newStateName)
		return
	end
	
	-- 1. Sai do estado anterior
	if data.CurrentState and data.CurrentState.Exit then
		data.CurrentState.Exit(npc, data.Context)
	end
	
	-- 2. Atualiza refer√™ncia
	local oldStateName = data.StateName
	data.CurrentState = newState
	data.StateName = newStateName
	data.StateTime = tick()
	
	-- 3. Entra no novo estado
	if newState.Enter then
		newState.Enter(npc, data.Context)
	end
	
	-- DEBUG (opcional)
	-- print(string.format("üîÑ [State] %s: %s -> %s", npc.Name, oldStateName, newStateName))
end

-- ======================================================================
-- ATUALIZA√á√ÉO
-- ======================================================================

function NPCStateMachine.Update(npc, dt)
	local data = StateData[npc]
	if not data or not data.CurrentState then return end
	
	-- Chama Update do estado atual
	if data.CurrentState.Update then
		data.CurrentState.Update(npc, data.Context, dt)
	end
end

-- ======================================================================
-- API P√öBLICA
-- ======================================================================

function NPCStateMachine.GetState(npc)
	local data = StateData[npc]
	return data and data.StateName or "None"
end

function NPCStateMachine.GetContext(npc)
	local data = StateData[npc]
	return data and data.Context or nil
end

function NPCStateMachine.Cleanup(npc)
	local data = StateData[npc]
	if data and data.CurrentState and data.CurrentState.Exit then
		data.CurrentState.Exit(npc, data.Context)
	end
	StateData[npc] = nil
end

return NPCStateMachine
